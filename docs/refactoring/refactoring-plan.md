# リファクタリング計画（ドラフト）

## 1. 現状分析

### 技術スタック・構成
- **バックエンド**: Node.js + TypeScript + Express（複数マイクロサービス）
- **データベース**: PostgreSQL（サービスごとに分散）
- **フロントエンド**: EJS + Bootstrap + jQuery（SPAではない）
- **API Gateway**: Kong
- **メッセージング**: Kafka
- **インフラ**: Docker Compose
- **共通モジュール**: shared/ 配下に集約

### 主な課題
- サービス分割過多・複雑性増大
- ドメイン設計・API設計・DB設計の整合性不明
- テストカバレッジ不足
- レガシーなフロントエンド
- サービス間同期通信依存
- 監視・運用の統一不足
- セキュリティ・認証認可の一部属人化

---

## 2. リファクタリング方針

### フェーズ1: 設計軸の明確化・共通化
- ドメインモデル・OpenAPI・DB定義の一元管理
- サービス間契約（OpenAPI）を中心に据えた設計プロセス
- コード生成・型定義の自動化

### フェーズ2: サービス統合・整理
- サービス数の適正化（例: 16→5ドメインサービス）
- データベース統合（スキーマ分離方式）
- 共通ライブラリの整理・重複排除

### フェーズ3: 技術刷新・品質向上
- フロントエンドをVue3+TypeScript（Nuxt3）へ刷新
- Jest/Supertestによるテストカバレッジ80%以上
- サーキットブレーカー等の障害耐性強化
- 監視・ロギングの統一（Prometheus, ELK等）

### フェーズ4: インフラ・運用最適化
- Docker Composeの簡素化・Kubernetes移行準備
- CI/CDパイプラインの最適化（GitHub Actions）
- セキュリティ強化（JWT, RBAC, 暗号化, 監査ログ）

---

## 3. 優先度付きアクションリスト

### Phase 1（1-2ヶ月）
- [ ] ドメインモデル・API・DB定義の一元化
- [ ] OpenAPI仕様の導入・自動コード生成
- [ ] サービス間通信の契約明確化
- [ ] テスト戦略の策定・単体テスト実装

### Phase 2（3-4ヶ月）
- [ ] サービス統合計画の策定・実施
- [ ] データベース統合（スキーマ分離）
- [ ] 共通モジュールの整理・重複排除
- [ ] サーキットブレーカー等の実装

### Phase 3（5-6ヶ月）
- [ ] フロントエンドのNuxt3移行
- [ ] テストカバレッジ80%以上
- [ ] 監視・ロギング統一
- [ ] パフォーマンス最適化

### Phase 4（6ヶ月以降）
- [ ] Kubernetes移行準備
- [ ] CI/CD最適化
- [ ] セキュリティ強化・監査体制整備

---

## 4. 成功指標（KPI例）

| 指標 | 現状 | 目標 |
|------|------|------|
| テストカバレッジ | 20% | 80% |
| サービス数 | 16 | 5 |
| API応答時間 | 500ms | 100ms |
| デプロイ頻度 | 月1回 | 日1回 |
| システム稼働率 | 95% | 99.9% |

---

## 5. 参考資料
- `docs/ecshop-comprehensive-implementation-plan.md`
- `SEPARATION_PLAN.md`
- 各サービス/共通モジュールの現状コード 